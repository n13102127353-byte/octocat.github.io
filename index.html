<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰›å“¥æ–°æ˜¥æ¸¸æˆ</title>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body { 
            margin: 0; 
            padding: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background-color: #3d0000; 
            font-family: "Microsoft YaHei", sans-serif; 
            overflow: hidden; 
            touch-action: none;
        }
        
        #game-container { 
            position: relative; 
            width: 100vw; 
            height: 100vh; 
            max-width: 450px; 
            max-height: 800px; 
            box-shadow: 0 0 50px #000; 
            border: 4px solid #ffd700; 
            background: #8b0000; 
            overflow: hidden; 
        }
        
        canvas { 
            display: block; 
            width: 100% !important;
            height: 100% !important;
            background: linear-gradient(to bottom, #7a0000, #b71c1c); 
        }
        
        /* é€šç”¨ UI */
        .overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.85); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 50; 
            color: #ffd700; 
        }
        
        .menu { 
            background: #8b0000; 
            padding: 20px; 
            border: 3px solid #ffd700; 
            border-radius: 15px; 
            text-align: center; 
            width: 85%; 
            max-width: 320px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); 
        }
        
        h1 { 
            font-size: clamp(24px, 6vw, 32px); 
            margin-bottom: 15px; 
            text-shadow: 2px 2px #000; 
            color: #ffd700; 
        }
        
        h2 { 
            margin: 10px 0; 
            color: #fff; 
            font-size: clamp(18px, 4.5vw, 24px);
        }
        
        button { 
            padding: 12px 20px; 
            font-size: clamp(16px, 4vw, 18px); 
            background: linear-gradient(to bottom, #ffd700, #ffca28); 
            border: 2px solid #b8860b; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 10px 5px; 
            border-radius: 25px; 
            color: #8b0000; 
            box-shadow: 0 4px 0 #b8860b; 
            transition: transform 0.1s; 
            min-height: 44px; 
            width: 80%;
            max-width: 200px;
        }
        
        button:active { 
            transform: translateY(3px); 
            box-shadow: 0 1px 0 #b8860b; 
        }
        
        input { 
            padding: 12px; 
            font-size: 16px; 
            width: 70%; 
            border-radius: 5px; 
            border: 2px solid #ffd700; 
            margin-bottom: 15px; 
            text-align: center; 
            background: #5d0000; 
            color: #fff; 
            min-height: 44px;
        }
        
        .rank-list { 
            width: 100%; 
            margin-top: 10px; 
            border-top: 1px solid #ffd700; 
        }
        
        .rank-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px dashed rgba(255,215,0,0.3); 
            font-size: clamp(12px, 3vw, 14px); 
            color: #fff; 
        }
        
        .rank-item span:first-child { 
            color: #ffd700; 
            font-weight: bold; 
        }

        .red-packet-box { 
            background: #d32f2f; 
            border: 4px solid #ffd700; 
            padding: 20px; 
            border-radius: 10px; 
            width: 85%; 
            max-width: 280px;
            text-align: center; 
            animation: popIn 0.3s ease-out; 
        }
        
        .code-display { 
            background: #fff; 
            color: #d32f2f; 
            font-size: clamp(18px, 5vw, 24px); 
            font-weight: bold; 
            padding: 10px; 
            margin: 15px 0; 
            border-radius: 5px; 
            border: 2px dashed #d32f2f; 
            user-select: text; 
            word-break: break-all;
        }
        
        @keyframes popIn { 
            from { transform: scale(0.5); opacity: 0; } 
            to { transform: scale(1); opacity: 1; } 
        }

        #score-display { 
            position: absolute; 
            top: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: clamp(30px, 8vw, 50px); 
            color: #ffd700; 
            text-shadow: 3px 3px 5px #000; 
            pointer-events: none; 
            z-index: 10; 
            font-weight: bold; 
        }
        
        #boss-ui { 
            position: absolute; 
            top: 80px; 
            width: 100%; 
            text-align: center; 
            color: #ffeb3b; 
            font-weight: bold; 
            display: none; 
            z-index: 10; 
            font-size: clamp(16px, 4vw, 20px); 
            text-shadow: 1px 1px 2px #000; 
            padding: 0 10px;
        }
        
        #countdown-ui { 
            position: absolute; 
            top: 40%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: clamp(40px, 12vw, 80px); 
            color: #fff; 
            font-weight: bold; 
            text-shadow: 0 0 10px #ffd700; 
            z-index: 60; 
            display: none; 
        }
        
        /* åŠ è½½ç•Œé¢æ ·å¼ */
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #7a0000, #b71c1c);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .loading-title {
            font-size: clamp(28px, 7vw, 36px);
            color: #ffd700;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px #000;
        }
        
        .loading-progress-container {
            width: 80%;
            max-width: 300px;
            height: 20px;
            background: #5d0000;
            border-radius: 10px;
            border: 2px solid #ffd700;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .loading-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #ffd700, #ffca28);
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        
        .loading-text {
            color: #fff;
            font-size: clamp(14px, 3.5vw, 16px);
            margin-top: 10px;
        }
        
        .loading-asset-list {
            color: #ffcccc;
            font-size: clamp(12px, 3vw, 14px);
            margin-top: 20px;
            text-align: center;
            max-height: 100px;
            overflow-y: auto;
            width: 80%;
            max-width: 300px;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="game-container">
    <!-- åŠ è½½ç•Œé¢ -->
    <div id="loading-screen">
        <h1 class="loading-title">ç‰›çš„é©¬å¹´æ¸¸æˆ</h1>
        <div class="loading-progress-container">
            <div class="loading-progress-bar" id="loading-bar"></div>
        </div>
        <div class="loading-text" id="loading-text">æ­£åœ¨åŠ è½½èµ„æº 0%</div>
        <div class="loading-asset-list" id="loading-asset-list"></div>
    </div>
    
    <!-- æ¸¸æˆç•Œé¢ -->
    <div id="score-display">0</div>
    <div id="boss-ui">ğŸ® å¹´å…½é™ä¸´ ğŸ®</div>
    <div id="countdown-ui">3</div>
    <canvas id="gameCanvas"></canvas>

    <div id="main-menu" class="overlay hidden">
        <div class="menu">
            <h1>ç‰›å“¥åŠ©ä½ é—¯å…³èµ¢çº¢åŒ…</h1>
            <button onclick="initGame()">èµ°ä½ </button>
            
            <div style="margin-top: 20px; text-align: left;">
                <h3 style="color:#ffd700; border-bottom: 2px solid #ffd700; padding-bottom:5px;">ğŸ† å¯ç»™æˆ‘èƒ½è€åäº†æ¦œ</h3>
                <div id="start-rank-list" class="rank-list"></div>
            </div>
        </div>
    </div>

    <div id="reward-menu" class="overlay hidden">
        <div class="red-packet-box">
            <h2>ğŸ‰ æ­å–œé—¯è¿‡ç¬¬ <span id="level-num">1</span> å…³!</h2>
            <p>æ¯å…³çº¢åŒ…ä¸ä¸€æ ·å…ˆåˆ°å…ˆå¾—</p>
            <p style="font-size: 14px; margin-top:10px; color:#ffcccc;">é•¿æŒ‰å¤åˆ¶ä¸‹æ–¹å£ä»¤æ‰“å¼€æ”¯ä»˜å®ï¼š</p>
            <div class="code-display" id="red-packet-code">XXXXX</div>
            <button onclick="continueGame()">æˆ‘è¦æ‹¿ä¸‹ä¸€å…³çº¢åŒ…</button>
        </div>
    </div>

    <div id="over-menu" class="overlay hidden">
        <div class="menu">
            <h2 style="color: #ff5252;">è¯´å‡ºå»ç¬‘æ­»ä¸ªäºº</h2>
            <p style="font-size: 18px;">æœ¬æ¬¡å¾—åˆ†: <span id="final-score" style="color: #ffd700; font-weight: bold; font-size: 24px;">0</span></p>
            <div id="name-input-area">
                <input type="text" id="player-name" placeholder="åœ¨è¿™å¡«ä½ çš„å" maxlength="8">
                <br>
                <button onclick="submitScore()">æˆ‘è¦è¿›èƒ½è€æ¦œ</button>
            </div>
            <div id="action-buttons" class="hidden">
                <button onclick="restartGame()">æˆ‘å†æ¥æ¥</button>
                <button onclick="location.reload()">è¿”å›ä¸»èœå•</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // ğŸµ éŸ³é¢‘é…ç½®åŒº
    // ==========================================
    const AUDIO_FILES = {
        bgm_menu: 'bgm_menu.mp3',
        bgm_game: 'bgm_game.mp3',
        bgm_boss: 'bgm_boss.mp3',
        sfx_jump: 'sfx_jump.mp3',
        sfx_shoot: 'sfx_shoot.mp3',
        sfx_die: 'sfx_die.mp3'
    };

    // éŸ³é¢‘ç®¡ç†å™¨
    const AUDIO = {};
    let currentBGM = null; // å½“å‰æ’­æ”¾çš„BGM
    let audioContextResolved = false; // éŸ³é¢‘ä¸Šä¸‹æ–‡æ˜¯å¦å·²è§£é”
    
    // éŸ³é¢‘æ’­æ”¾è¾…åŠ©å‡½æ•°
    function playSound(name) {
        if(AUDIO[name]) {
            AUDIO[name].currentTime = 0;
            AUDIO[name].play().catch(e => {
                console.log("éŸ³é¢‘æ’­æ”¾é”™è¯¯:", e);
                // å¦‚æœå› ä¸ºç”¨æˆ·äº¤äº’ç­–ç•¥å¤±è´¥ï¼Œå°è¯•è§£é”éŸ³é¢‘
                if (!audioContextResolved) {
                    unlockAudio();
                }
            });
        }
    }
    
    // æ’­æ”¾BGMï¼ˆèƒŒæ™¯éŸ³ä¹ï¼‰
    function playBGM(name) {
        // å¦‚æœå·²ç»æ˜¯å½“å‰æ’­æ”¾çš„BGMï¼Œä¸é‡å¤æ’­æ”¾
        if (currentBGM === name && AUDIO[name] && !AUDIO[name].paused) {
            return;
        }
        
        // å…ˆæš‚åœæ‰€æœ‰BGM
        ['bgm_menu', 'bgm_game', 'bgm_boss'].forEach(k => {
            if(AUDIO[k] && AUDIO[k] !== AUDIO[name]) {
                AUDIO[k].pause();
                AUDIO[k].currentTime = 0;
            }
        });
        
        // æ’­æ”¾æŒ‡å®šçš„BGM
        if(AUDIO[name]) {
            AUDIO[name].loop = true;
            AUDIO[name].volume = 0.6;
            currentBGM = name;
            
            // å°è¯•æ’­æ”¾ï¼Œå¦‚æœå¤±è´¥åˆ™è§£é”éŸ³é¢‘ä¸Šä¸‹æ–‡
            AUDIO[name].play().then(() => {
                audioContextResolved = true;
                console.log(`å¼€å§‹æ’­æ”¾BGM: ${name}`);
            }).catch(e => {
                console.log("BGMæ’­æ”¾å¤±è´¥ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’:", e);
                // è®°å½•éœ€è¦æ’­æ”¾çš„BGMï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’
                pendingBGM = name;
            });
        }
    }
    
    // è§£é”éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆç”¨æˆ·äº¤äº’åè°ƒç”¨ï¼‰
    function unlockAudio() {
        if (audioContextResolved) return;
        
        // åˆ›å»ºä¸€ä¸ªçŸ­æš‚çš„éŸ³é¢‘æ¥è§£é”éŸ³é¢‘ä¸Šä¸‹æ–‡
        const unlockSound = new Audio();
        unlockSound.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ';
        unlockSound.volume = 0;
        
        unlockSound.play().then(() => {
            audioContextResolved = true;
            unlockSound.pause();
            unlockSound.currentTime = 0;
            
            console.log("éŸ³é¢‘ä¸Šä¸‹æ–‡å·²è§£é”");
            
            // å¦‚æœæœ‰å¾…æ’­æ”¾çš„BGMï¼Œç°åœ¨æ’­æ”¾å®ƒ
            if (pendingBGM && AUDIO[pendingBGM]) {
                playBGM(pendingBGM);
                pendingBGM = null;
            }
        }).catch(e => {
            console.log("éŸ³é¢‘è§£é”å¤±è´¥:", e);
        });
    }
    
    // ç”¨æˆ·äº¤äº’æ—¶è§£é”éŸ³é¢‘
    function handleUserInteraction() {
        if (!audioContextResolved) {
            unlockAudio();
        }
    }
    
    let pendingBGM = null; // ç­‰å¾…æ’­æ”¾çš„BGM
    
    // ==========================================
    // ğŸ“¦ èµ„æºåŠ è½½ç®¡ç†
    // ==========================================
    const RESOURCES = {
        images: {
            horse: 'horse.png',
            boss: 'boss.png',
            bullet: 'bullet.png'
        },
        audio: AUDIO_FILES
    };
    
    let loadedResources = 0;
    let totalResources = 0;
    
    function initResources() {
        // è®¡ç®—æ€»èµ„æºæ•°
        totalResources = Object.keys(RESOURCES.images).length + Object.keys(RESOURCES.audio).length;
        
        // æ˜¾ç¤ºèµ„æºåˆ—è¡¨
        const assetList = document.getElementById('loading-asset-list');
        let html = '<div>æ­£åœ¨åŠ è½½èµ„æº:</div>';
        
        // åŠ è½½å›¾ç‰‡èµ„æº
        for (const [key, src] of Object.entries(RESOURCES.images)) {
            html += `<div>ğŸ“· ${key}.png...</div>`;
            const img = new Image();
            img.onload = () => updateProgress(key, 'image');
            img.onerror = () => updateProgress(key, 'image', true);
            img.src = src;
            ASSETS[key].img = img;
        }
        
        // åŠ è½½éŸ³é¢‘èµ„æº
        for (const [key, src] of Object.entries(RESOURCES.audio)) {
            html += `<div>ğŸµ ${key}...</div>`;
            const audio = new Audio();
            audio.preload = 'auto';
            
            // æ·»åŠ å¤šä¸ªäº‹ä»¶ç›‘å¬ç¡®ä¿åŠ è½½å®Œæˆ
            let loaded = false;
            const onLoad = () => {
                if (!loaded) {
                    loaded = true;
                    updateProgress(key, 'audio');
                }
            };
            
            audio.addEventListener('canplaythrough', onLoad);
            audio.addEventListener('loadeddata', onLoad);
            audio.addEventListener('error', () => {
                if (!loaded) {
                    loaded = true;
                    updateProgress(key, 'audio', true);
                }
            });
            
            // è®¾ç½®éŸ³é¢‘å±æ€§
            audio.loop = (key.startsWith('bgm_'));
            audio.volume = 0.6;
            audio.src = src;
            
            AUDIO[key] = audio;
        }
        
        assetList.innerHTML = html;
        
        // ä¸ºäº†ç¡®ä¿éŸ³é¢‘èƒ½åŠ è½½ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•é¢„åŠ è½½
        setTimeout(() => {
            // å¦‚æœæœ‰äº›éŸ³é¢‘è¿˜æ²¡è§¦å‘åŠ è½½äº‹ä»¶ï¼Œå¼ºåˆ¶æ›´æ–°è¿›åº¦
            for (const key in RESOURCES.audio) {
                if (AUDIO[key] && AUDIO[key].readyState >= 2) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ›´æ–°è¿‡è¿›åº¦
                    const items = assetList.querySelectorAll('div');
                    let found = false;
                    items.forEach(item => {
                        if (item.textContent.includes(key) && !item.textContent.includes('âœ…') && !item.textContent.includes('âŒ')) {
                            found = true;
                        }
                    });
                    if (found) {
                        updateProgress(key, 'audio');
                    }
                }
            }
        }, 2000);
    }
    
    function updateProgress(name, type, isError = false) {
        loadedResources++;
        const progress = Math.floor((loadedResources / totalResources) * 100);
        
        // æ›´æ–°è¿›åº¦æ¡
        const progressBar = document.getElementById('loading-bar');
        progressBar.style.width = progress + '%';
        
        // æ›´æ–°è¿›åº¦æ–‡æœ¬
        const progressText = document.getElementById('loading-text');
        if (isError) {
            progressText.innerHTML = `${name} åŠ è½½å¤±è´¥ï¼Œç»§ç»­åŠ è½½... (${progress}%)`;
        } else {
            progressText.innerHTML = `æ­£åœ¨åŠ è½½èµ„æº ${progress}%`;
        }
        
        // æ›´æ–°èµ„æºåˆ—è¡¨ä¸­çš„çŠ¶æ€
        const assetList = document.getElementById('loading-asset-list');
        const items = assetList.querySelectorAll('div');
        items.forEach(item => {
            if (item.textContent.includes(name)) {
                if (isError) {
                    item.innerHTML = item.innerHTML.replace('...', ' âŒ åŠ è½½å¤±è´¥');
                } else if (!item.innerHTML.includes('âœ…') && !item.innerHTML.includes('âŒ')) {
                    item.innerHTML = item.innerHTML.replace('...', ' âœ… å·²åŠ è½½');
                }
            }
        });
        
        // æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
        if (loadedResources >= totalResources) {
            setTimeout(() => {
                showMainMenu();
                // è‡ªåŠ¨æ’­æ”¾ä¸»èœå•éŸ³ä¹
                playBGM('bgm_menu');
            }, 500);
        }
    }
    
    function showMainMenu() {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('main-menu').classList.remove('hidden');
        renderStartLeaderboard();
        
        // æ·»åŠ ç”¨æˆ·äº¤äº’ç›‘å¬å™¨æ¥è§£é”éŸ³é¢‘
        const menuButton = document.querySelector('#main-menu button');
        if (menuButton) {
            menuButton.addEventListener('click', handleUserInteraction);
        }
    }
    
    // ==========================================
    // ğŸ§§ çº¢åŒ…é…ç½®åŒº
    // ==========================================
    const RED_PACKETS = [
        "é©¬å¹´å¤§å‰888", "è´¢æºå¹¿è¿›666", "æ­¥æ­¥é«˜å‡2026", "ä¸‡äº‹å¦‚æ„999", "æ­å–œå‘è´¢520"
    ];

    // ==========================================
    // ğŸ® æ¸¸æˆæ ¸å¿ƒé€»è¾‘
    // ==========================================
    const ASSETS = {
        horse: { img: null, emoji: 'ğŸ' },
        boss:  { img: null, emoji: 'ğŸ‘¹' },
        bullet:{ img: null, emoji: 'ğŸ§¨' }
    };
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // åŠ¨æ€è®¾ç½®ç”»å¸ƒå°ºå¯¸
    function resizeCanvas() {
        const container = document.getElementById('game-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        canvas.width = width;
        canvas.height = height;
        
        // æ ¹æ®æ–°çš„å°ºå¯¸è°ƒæ•´æ¸¸æˆå‚æ•°
        adjustGameParams();
    }
    
    // æ ¹æ®å±å¹•å°ºå¯¸è°ƒæ•´æ¸¸æˆå‚æ•°
    function adjustGameParams() {
        const baseWidth = 400;
        const baseHeight = 600;
        const scaleX = canvas.width / baseWidth;
        const scaleY = canvas.height / baseHeight;
        const scale = Math.min(scaleX, scaleY);
        
        // ä¿å­˜ç¼©æ”¾æ¯”ä¾‹
        gameScale = scale;
        gameOffsetX = (canvas.width - baseWidth * scale) / 2;
        gameOffsetY = (canvas.height - baseHeight * scale) / 2;
    }
    
    // ç»˜åˆ¶ç¼©æ”¾åçš„æ¸¸æˆ
    function drawScaled() {
        ctx.save();
        ctx.translate(gameOffsetX, gameOffsetY);
        ctx.scale(gameScale, gameScale);
        
        // ç»˜åˆ¶æ¸¸æˆèƒŒæ™¯
        ctx.fillStyle = "#8b0000";
        ctx.fillRect(0, 0, 400, 600);
        
        // ç»˜åˆ¶æ¸å˜èƒŒæ™¯
        const gradient = ctx.createLinearGradient(0, 0, 0, 600);
        gradient.addColorStop(0, "#7a0000");
        gradient.addColorStop(1, "#b71c1c");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 400, 600);
        
        // ç»˜åˆ¶ç®¡é“ - ä¿®å¤é—®é¢˜ï¼šç¡®ä¿æ¯ä¸ªç®¡é“éƒ½æ˜¯ç‹¬ç«‹çš„
        ctx.fillStyle = "#ffd700";
        pipes.forEach(p => {
            // ç»˜åˆ¶ä¸Šç®¡é“
            ctx.fillRect(p.x, 0, p.w, p.top);
            // ç»˜åˆ¶ä¸‹ç®¡é“ - ä¿®å¤ï¼šç¡®ä¿ä»æ­£ç¡®çš„ä½ç½®å¼€å§‹ç»˜åˆ¶
            const bottomY = p.top + config.pipeGap;
            const bottomHeight = 600 - bottomY;
            ctx.fillRect(p.x, bottomY, p.w, bottomHeight);
        });
        
        if (gameState === 'BOSS') {
            // ç»˜åˆ¶BOSS
            if (ASSETS.boss.img && ASSETS.boss.img.complete && ASSETS.boss.img.naturalWidth > 0) {
                ctx.drawImage(ASSETS.boss.img, 300, bossY, 100, 100);
            } else {
                ctx.font = "80px Arial"; 
                ctx.fillText(ASSETS.boss.emoji, 310, bossY + 70);
            }
        }
        
        // ç»˜åˆ¶å­å¼¹
        bullets.forEach(b => {
            if (ASSETS.bullet.img && ASSETS.bullet.img.complete && ASSETS.bullet.img.naturalWidth > 0) {
                ctx.drawImage(ASSETS.bullet.img, b.x, b.y, b.w, b.h);
            } else {
                ctx.font = "30px Arial"; 
                ctx.fillText(ASSETS.bullet.emoji, b.x, b.y + 20);
            }
        });
        
        // ç»˜åˆ¶é©¬
        ctx.save();
        ctx.translate(horse.x + horse.w/2, horse.y + horse.h/2);
        if (gameState === 'PLAYING' || gameState === 'BOSS') {
            ctx.rotate(Math.min(Math.PI/6, Math.max(-Math.PI/6, horse.v * 0.1)));
        }
        if (ASSETS.horse.img && ASSETS.horse.img.complete && ASSETS.horse.img.naturalWidth > 0) {
            ctx.drawImage(ASSETS.horse.img, -horse.w/2, -horse.h/2, horse.w, horse.h);
        } else {
            ctx.font = "45px Arial"; 
            ctx.fillText(ASSETS.horse.emoji, -25, 15);
        }
        ctx.restore();
        
        ctx.restore();
    }
    
    // åˆå§‹åŒ–é…ç½®
    const config = {
        gravity: 0.14, 
        jump: -4.0, 
        pipeSpeed: 1.3, 
        pipeSpawnRate: 250, 
        pipeGap: 220,
        bossDuration: 20000, 
        bossSafeTime: 3000, 
        waveInterval: 3000, 
        bulletGap: 200, 
        bulletSpeed: 2.5
    };
    
    let horse, pipes, bullets, score, gameActive = false;
    let gameState = 'IDLE'; 
    let bossY = 250, bossDir = 1, lastBossScore = -1;
    let bossStartTime = 0, lastWaveTime = 0, nextBulletTime = 0;
    let bulletQueue = 0;
    let countdownVal = 3;
    let gameScale = 1;
    let gameOffsetX = 0, gameOffsetY = 0;
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–èµ„æº
    window.addEventListener('load', () => {
        resizeCanvas();
        initResources();
        
        // æ·»åŠ å…¨å±€ç”¨æˆ·äº¤äº’ç›‘å¬ï¼ˆè§¦æ‘¸å’Œç‚¹å‡»ï¼‰
        document.addEventListener('click', handleUserInteraction);
        document.addEventListener('touchstart', handleUserInteraction);
    });
    
    // çª—å£å¤§å°è°ƒæ•´
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', resizeCanvas);
    
    function handleAction(e) {
        if (e) e.preventDefault();
        if (gameActive && (gameState === 'PLAYING' || gameState === 'BOSS')) {
            horse.v = config.jump;
            playSound('sfx_jump');
        }
        
        // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²è§£é”
        handleUserInteraction();
    }
    
    // äº‹ä»¶ç›‘å¬
    window.addEventListener('keydown', (e) => { 
        if(e.code === 'Space' || e.code === 'ArrowUp') handleAction(e); 
    });
    
    canvas.addEventListener('mousedown', handleAction);
    canvas.addEventListener('touchstart', function(e) {
        handleAction(e);
        e.preventDefault();
        e.stopPropagation();
    }, { passive: false });
    
    // é˜²æ­¢é¡µé¢æ»šåŠ¨
    document.addEventListener('touchmove', function(e) {
        if(gameActive) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // æ¸¸æˆåˆå§‹åŒ–
    function initGame() {
        // è®¾ç½®æ¸¸æˆåˆå§‹çŠ¶æ€
        horse = { x: 80, y: 300, v: 0, w: 50, h: 40 };
        pipes = []; 
        bullets = []; 
        score = 0; 
        lastBossScore = -1; 
        bulletQueue = 0;
        
        gameActive = true;
        gameState = 'PLAYING';
        
        playBGM('bgm_game');
        
        document.getElementById('score-display').innerText = '0';
        document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
        document.getElementById('boss-ui').style.display = 'none';
        
        // å¼€å§‹æ¸¸æˆå¾ªç¯
        gameLoop();
    }
    
    function restartGame() {
        initGame();
    }
    
    // æ¸¸æˆä¸»å¾ªç¯
    function gameLoop() {
        if (!gameActive) return;
        
        update();
        drawScaled();
        
        requestAnimationFrame(gameLoop);
    }
    
    function update() {
        if (!gameActive) return;
        
        // æ›´æ–°é©¬çš„ä½ç½®
        if (gameState === 'PLAYING' || gameState === 'BOSS') {
            horse.v += config.gravity;
            horse.y += horse.v;
            
            // è¾¹ç•Œæ£€æµ‹
            if (horse.y > 560 || horse.y < -50) {
                gameOver();
                return;
            }
        }
        
        if (gameState === 'PLAYING') {
            updateNormal();
        } else if (gameState === 'BOSS') {
            updateBoss();
        }
    }
    
    function updateNormal() {
        // ç”Ÿæˆæ–°ç®¡é“ - ä¿®å¤ç®¡é“ç”Ÿæˆé€»è¾‘
        const lastPipe = pipes[pipes.length - 1];
        
        // åªæœ‰å½“ç®¡é“è¶³å¤Ÿè¿œæ—¶æ‰ç”Ÿæˆæ–°çš„
        if (!lastPipe || lastPipe.x < (400 - config.pipeSpawnRate)) {
            // éšæœºç”Ÿæˆç®¡é“é«˜åº¦ï¼Œç¡®ä¿ä¸ä¼šè¿åœ¨ä¸€èµ·
            let topHeight;
            if (pipes.length === 0) {
                topHeight = Math.random() * 200 + 100;
            } else {
                // åŸºäºä¸Šä¸€ä¸ªç®¡é“çš„ä½ç½®ç”Ÿæˆæ–°çš„ç®¡é“ä½ç½®
                const lastTop = pipes[pipes.length - 1].top;
                const minDistance = 50; // æœ€å°å‚ç›´è·ç¦»
                
                // ç¡®ä¿æ–°ç®¡é“ä¸ä¸Šä¸€ä¸ªç®¡é“æœ‰è¶³å¤Ÿçš„å‚ç›´è·ç¦»
                do {
                    topHeight = Math.random() * 200 + 100;
                } while (Math.abs(topHeight - lastTop) < minDistance);
            }
            
            pipes.push({ 
                x: 400, 
                top: topHeight, 
                w: 60, 
                passed: false 
            });
        }
        
        // æ›´æ–°ç®¡é“ä½ç½®
        for (let i = pipes.length - 1; i >= 0; i--) {
            pipes[i].x -= config.pipeSpeed;
            
            // ç¢°æ’æ£€æµ‹
            if (horse.x + 8 < pipes[i].x + pipes[i].w &&
                horse.x + horse.w - 8 > pipes[i].x &&
                (horse.y + 8 < pipes[i].top || horse.y + horse.h - 8 > pipes[i].top + config.pipeGap)) {
                gameOver();
                return;
            }
            
            // å¾—åˆ†
            if (!pipes[i].passed && horse.x > pipes[i].x + pipes[i].w) {
                score++;
                document.getElementById('score-display').innerText = score;
                pipes[i].passed = true;
                
                // æ¯10åˆ†è§¦å‘BOSSæˆ˜
                if (score > 0 && score % 10 === 0 && score !== lastBossScore) {
                    startBossBattle();
                    lastBossScore = score;
                    return;
                }
            }
            
            // ç§»é™¤å±å¹•å¤–çš„ç®¡é“
            if (pipes[i].x < -80) pipes.splice(i, 1);
        }
    }
    
    function startBossBattle() {
        gameState = 'BOSS';
        bossStartTime = Date.now();
        lastWaveTime = bossStartTime; 
        bulletQueue = 0;
        pipes = [];
        
        playBGM('bgm_boss');
        document.getElementById('boss-ui').style.display = 'block';
    }
    
    function updateBoss() {
        const now = Date.now();
        const elapsed = now - bossStartTime;
        const remaining = Math.max(0, config.bossDuration - elapsed);
        
        // æ›´æ–°BOSSä½ç½®
        bossY += bossDir * 2.5;
        if (bossY > 440 || bossY < 60) bossDir *= -1;
        
        // æ˜¾ç¤ºBOSSæˆ˜UI
        if (elapsed < config.bossSafeTime) {
            document.getElementById('boss-ui').innerText = `ğŸ® å¹´å…½é™ä¸´ï¼å‡†å¤‡... ${Math.ceil((config.bossSafeTime - elapsed)/1000)}s`;
        } else {
            const currentLevel = Math.floor(score / 10);
            document.getElementById('boss-ui').innerText = `ğŸ® èº²é¿æ”»å‡»(${currentLevel}è¿å‘)ï¼š${Math.ceil(remaining/1000)}s`;
            
            // ç”Ÿæˆå­å¼¹æ³¢
            if (elapsed > config.bossSafeTime && 
                now - lastWaveTime > config.waveInterval && 
                bulletQueue === 0 && 
                remaining > 2000) {
                bulletQueue = currentLevel;
                lastWaveTime = now;
            }
            
            // å‘å°„å­å¼¹
            if (bulletQueue > 0 && now > nextBulletTime) {
                bullets.push({ 
                    x: 350, 
                    y: bossY + 25, 
                    w: 30, 
                    h: 20 
                });
                playSound('sfx_shoot');
                bulletQueue--;
                nextBulletTime = now + config.bulletGap;
            }
        }
        
        // æ›´æ–°å­å¼¹ä½ç½®å’Œç¢°æ’æ£€æµ‹
        for (let i = bullets.length - 1; i >= 0; i--) {
            bullets[i].x -= config.bulletSpeed;
            
            // ç¢°æ’æ£€æµ‹
            if (checkRectCollision(horse, bullets[i])) {
                gameOver();
                return;
            }
            
            // ç§»é™¤å±å¹•å¤–çš„å­å¼¹
            if (bullets[i].x < -50) bullets.splice(i, 1);
        }
        
        // BOSSæˆ˜ç»“æŸ
        if (remaining <= 0) {
            showReward();
        }
    }
    
    function showReward() {
        gameState = 'REWARD';
        bullets = [];
        playBGM('bgm_menu');
        document.getElementById('boss-ui').style.display = 'none';
        
        const level = Math.floor(score / 10);
        const code = RED_PACKETS[level - 1] || "æ­å–œå‘è´¢2026";
        
        document.getElementById('level-num').innerText = level;
        document.getElementById('red-packet-code').innerText = code;
        document.getElementById('reward-menu').classList.remove('hidden');
    }
    
    function continueGame() {
        document.getElementById('reward-menu').classList.add('hidden');
        startCountdown();
    }
    
    function startCountdown() {
        gameState = 'COUNTDOWN';
        countdownVal = 3;
        const countUI = document.getElementById('countdown-ui');
        countUI.innerText = countdownVal;
        countUI.style.display = 'block';
        
        const timer = setInterval(() => {
            countdownVal--;
            if (countdownVal > 0) {
                countUI.innerText = countdownVal;
            } else {
                clearInterval(timer);
                countUI.style.display = 'none';
                gameState = 'PLAYING';
                playBGM('bgm_game');
            }
        }, 1000);
    }
    
    function checkRectCollision(r1, r2) {
        const p = 8; // ç¢°æ’å®¹å·®
        return r1.x + p < r2.x + r2.w && 
               r1.x + r1.w - p > r2.x &&
               r1.y + p < r2.y + r2.h && 
               r1.y + r1.h - p > r2.y;
    }
    
    function gameOver() {
        gameActive = false;
        
        playSound('sfx_die');
        ['bgm_game', 'bgm_boss'].forEach(k => {
            if(AUDIO[k]) AUDIO[k].pause();
        });
        
        document.getElementById('final-score').innerText = score;
        document.getElementById('boss-ui').style.display = 'none';
        document.getElementById('countdown-ui').style.display = 'none';
        
        // æ˜¾ç¤ºæ¸¸æˆç»“æŸèœå•
        document.getElementById('over-menu').classList.remove('hidden');
        
        // é‡ç½®è¾“å…¥çŠ¶æ€
        document.getElementById('name-input-area').classList.remove('hidden');
        document.getElementById('action-buttons').classList.add('hidden');
        document.getElementById('player-name').value = '';
    }
    
    function submitScore() {
        const name = document.getElementById('player-name').value.trim() || "æ— åè‹±é›„";
        let board = JSON.parse(localStorage.getItem('horseRanking') || "[]");
        board.push({ name, score });
        board.sort((a, b) => b.score - a.score);
        board = board.slice(0, 5);
        localStorage.setItem('horseRanking', JSON.stringify(board));
        
        document.getElementById('name-input-area').classList.add('hidden');
        document.getElementById('action-buttons').classList.remove('hidden');
    }
    
    function renderStartLeaderboard() {
        const board = JSON.parse(localStorage.getItem('horseRanking') || "[]");
        const listEl = document.getElementById('start-rank-list');
        
        if (board.length === 0) {
            listEl.innerHTML = '<div class="rank-item" style="justify-content:center; color:#ccc;">æš‚æ— è®°å½•ï¼Œç­‰ä½ æ¥æˆ˜ï¼</div>';
            return;
        }
        
        let html = '';
        board.forEach((item, index) => {
            let icon = index === 0 ? 'ğŸ¥‡' : 
                      (index === 1 ? 'ğŸ¥ˆ' : 
                      (index === 2 ? 'ğŸ¥‰' : `${index + 1}.`));
            html += `
                <div class="rank-item">
                    <span>${icon} ${item.name}</span>
                    <span>${item.score}åˆ†</span>
                </div>`;
        });
        listEl.innerHTML = html;
    }
</script>
</body>
</html>